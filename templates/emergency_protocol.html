{% extends "base.html" %}

{% block title %}Respiratory Emergency Protocol - ALS Caregiver's Compass{% endblock %}

{% block extra_css %}
<style>
    .protocol-page {
        background: var(--color-background);
        padding: var(--space-8) 0 var(--space-16);
    }

    .protocol-header {
        text-align: center;
        padding: var(--space-8) 0;
        border-bottom: 2px solid var(--color-border);
        margin-bottom: var(--space-8);
    }

    .protocol-header h1 {
        font-size: var(--font-size-3xl);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2);
    }

    .protocol-header p {
        font-size: var(--font-size-md);
        color: var(--color-text-secondary);
        margin: 0;
    }

    .section-box {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-6);
    }

    .section-box h2 {
        font-size: var(--font-size-xl);
        color: var(--color-text-primary);
        margin-bottom: var(--space-4);
    }

    .section-box h3 {
        font-size: var(--font-size-lg);
        color: var(--color-text-primary);
        margin-bottom: var(--space-3);
    }

    .warning-box {
        background: var(--color-warning-light);
        border: 2px solid var(--color-warning);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin: var(--space-6) 0;
    }

    .warning-box h3 {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--color-text-primary);
        margin-bottom: var(--space-3);
    }

    .tip-box {
        background: var(--color-success-light);
        border-left: 3px solid var(--color-success);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin: var(--space-4) 0;
    }

    .step-num {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 26px;
        height: 26px;
        background: var(--color-primary);
        color: white;
        border-radius: 50%;
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-semibold);
        margin-right: var(--space-2);
        flex-shrink: 0;
    }

    .param-box {
        display: inline-block;
        background: var(--color-surface-alt);
        border: 1px solid var(--color-border);
        padding: 2px 10px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: var(--font-size-sm);
        margin: var(--space-1);
        color: var(--color-text-primary);
    }

    .highlight {
        background: #fef9c3;
        padding: 2px 6px;
        border-radius: var(--radius-sm);
    }

    .grid-2 {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-6);
    }

    @media (min-width: 768px) {
        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }
    }

    .grid-4 {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }

    @media (min-width: 768px) {
        .grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1024px) {
        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    .chart-container {
        background: #fafafa;
        padding: var(--space-6);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        overflow-x: auto;
        margin: var(--space-6) 0;
    }

    .contact-input {
        border-bottom: 2px solid var(--color-border);
        padding: var(--space-2) 0;
        margin-top: var(--space-1);
        min-height: 32px;
    }

    .footer-note {
        text-align: center;
        color: var(--color-text-tertiary);
        font-size: var(--font-size-xs);
        margin-top: var(--space-8);
        padding-top: var(--space-4);
        border-top: 1px solid var(--color-border);
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
{% endblock %}

{% block content %}
<div class="protocol-page">
    <div class="container" style="max-width: 1000px;">

        <!-- Header -->
        <div class="protocol-header">
            <h1>Respiratory Emergency Protocol</h1>
            <p>Practical Guide for Home Ventilator Care</p>
        </div>

        <!-- Core Principle -->
        <div class="section-box">
            <h2>Core Principle: Involve PALS in Every Decision</h2>
            <p style="margin-bottom: var(--space-4);">With time and experience, PALS understands their body better than
                anyone. They learn to recognize patterns and guide you on what works.</p>

            <div class="grid-2">
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Over time, PALS
                        can tell you:</p>
                    <ul style="color: var(--color-text-secondary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>"I think I need Ambu now"</li>
                        <li>"This feels like deep suction is needed"</li>
                        <li>"Cough stuck near balloon area"</li>
                        <li>"Pressure feels insufficient"</li>
                        <li>"Check ventilator - something feels off"</li>
                    </ul>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Always ask PALS:
                    </p>
                    <ul style="color: var(--color-text-secondary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>How are you feeling right now?</li>
                        <li>Is ventilator pressure feeling OK?</li>
                        <li>Any cough stuck? Where?</li>
                        <li>Feeling dry cough or wet secretions?</li>
                        <li>Balloon feeling too tight/loose?</li>
                    </ul>
                </div>
            </div>

            <div class="tip-box">
                <p style="margin: 0;"><strong>Key Insight:</strong> The more you involve PALS in daily decisions, the
                    more they understand what helps them. PALS becomes your best guide.</p>
            </div>
        </div>

        <!-- What We Monitor -->
        <div class="section-box">
            <h2>What We Monitor</h2>
            <p style="margin-bottom: var(--space-3);">When PALS shows discomfort, check these parameters:</p>

            <div style="margin-bottom: var(--space-4);">
                <span class="param-box">SpO2</span>
                <span class="param-box">Pulse / HR</span>
                <span class="param-box">Blood Pressure</span>
                <span class="param-box">Tidal Volume</span>
                <span class="param-box">Respiratory Rate</span>
                <span class="param-box">Vent Graph</span>
                <span class="param-box">Leak Values</span>
            </div>

            <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Changes in these parameters
                indicate something is wrong. But <span class="highlight">always combine readings with PALS
                    feedback</span> - they often sense discomfort before numbers change.</p>
        </div>

        <!-- Two Person Approach -->
        <div class="section-box">
            <h2>Two-Person Approach</h2>
            <div class="grid-2">
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Person 1:
                        Immediate Care</p>
                    <ul style="color: var(--color-text-secondary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>Start Ambu if needed</li>
                        <li>Talk to PALS, get feedback</li>
                        <li>Perform suction/neb</li>
                    </ul>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Person 2:
                        Support</p>
                    <ul style="color: var(--color-text-secondary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>Check equipment & connections</li>
                        <li>Prepare supplies</li>
                        <li>Monitor parameters</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Decision Flowchart -->
        <h2 style="margin-top: var(--space-8); margin-bottom: var(--space-2); color: var(--color-text-primary);">
            Decision Flowchart</h2>
        <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">Follow the path based on what you
            observe and what PALS tells you</p>

        <div class="chart-container">
            <div class="mermaid">
                flowchart TD
                Start([PALS showing discomfort])
                Start --> Ask[Ask PALS: What feels wrong?]
                Ask --> Check[Check SpO2, Pulse, BP, TV]
                Check --> Branch{What do you see?}

                Branch -->|SpO2 dropping| PathA[Breathing Issue]
                Branch -->|High Pulse/BP| PathB[Discomfort Issue]
                Branch -->|Pressure feels low| PathC[Ventilator Check]

                PathA --> Ambu[Give Ambu immediately]
                Ambu --> Type{Secretion type?}
                Type -->|Wet/gurgling| Wet[NS + Ambu + Suction]
                Type -->|Dry cough| Dry[Nebulization first]
                Type -->|Stuck at balloon| Balloon[Subglottic suction]

                PathB --> Relief[Ambu for 1 min]
                Relief --> Clear[Clearance cycle]
                Clear --> Better{Better?}
                Better -->|Yes| Done1[Stable]
                Better -->|No| Fever[Check for fever/infection]

                PathC --> VCheck[Check settings & connections]
                VCheck --> Leak{High leak?}
                Leak -->|Yes| Fix[Fix connections/cuff]
                Leak -->|No| Tech[Call technician]

                Wet --> SubG[TT suction]
                Dry --> SubG
                Balloon --> SubG
                SubG --> Stable{PALS better?}
                Stable -->|Yes| Done2[Stable]
                Stable -->|No| Repeat[Repeat cycle]
                Repeat --> Ambu
            </div>
        </div>

        <!-- Key Situations -->
        <h2 style="margin-top: var(--space-8); margin-bottom: var(--space-4); color: var(--color-text-primary);">
            Understanding Each Situation</h2>

        <!-- Situation A -->
        <div class="section-box">
            <h3>Situation A: SpO2 Dropping</h3>
            <p style="margin-bottom: var(--space-3);">Indicates airway or secretion issue. PALS may feel breathless.</p>

            <div class="grid-2">
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Sequence:</p>
                    <div style="font-size: var(--font-size-sm); line-height: 1.8;">
                        <p><span class="step-num">1</span>Give Ambu - provides relief</p>
                        <p><span class="step-num">2</span>Ask PALS what they feel</p>
                        <p><span class="step-num">3</span>NS + Ambu + Suction (skip NS if uncomfortable)</p>
                        <p><span class="step-num">4</span>Subglottic suction</p>
                        <p><span class="step-num">5</span>Repeat until better</p>
                    </div>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Path Selection:
                    </p>
                    <ul style="font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.8;">
                        <li><strong>Wet/gurgling:</strong> NS + Ambu + Suction</li>
                        <li><strong>Dry cough:</strong> Nebulization first</li>
                        <li><strong>Stuck at balloon:</strong> Subglottic first</li>
                        <li><strong>Catheter blocked:</strong> Consider tube change</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Situation B -->
        <div class="section-box">
            <h3>Situation B: High Pulse/BP with Normal SpO2</h3>

            <div class="tip-box">
                <p style="margin: 0;"><strong>Important:</strong> If PALS is not a BP patient, high BP/pulse usually
                    means <span class="highlight">breathing discomfort</span>.</p>
            </div>

            <p style="font-weight: var(--font-weight-semibold); margin:  var(--space-3) 0 var(--space-2);">Quick Relief:
            </p>
            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Give Ambu for 1 minute. This
                provides immediate relief and helps stabilize while you find the cause. If pulse/BP settle, breathing
                discomfort was the issue.</p>

            <p style="font-weight: var(--font-weight-semibold); margin: var(--space-3) 0 var(--space-2);">Common causes:
            </p>
            <ul style="font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.8;">
                <li>Fever/Infection → Check temperature, get CBC</li>
                <li>Stuck secretions → Clearance cycle helps</li>
                <li>Insufficient pressure → PALS feels vent not giving enough</li>
            </ul>
        </div>

        <!-- Situation C -->
        <div class="section-box">
            <h3>Situation C: Pressure Feels Insufficient</h3>
            <p style="margin-bottom: var(--space-3);">PALS feels ventilator not delivering enough pressure.</p>

            <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Check:</p>
            <ul style="font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.8;">
                <li>Ventilator settings - any changes?</li>
                <li>Circuit connections - all tight?</li>
                <li>Leak values - higher than usual?</li>
                <li>Cuff/balloon - properly inflated?</li>
            </ul>

            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-3);">
                <strong>Test:</strong> Give Ambu temporarily. If PALS feels better with Ambu, issue is with ventilator -
                call technician.
            </p>
        </div>

        <!-- Ambu -->
        <div class="section-box">
            <h3>Ambu Bag: Your Best Tool</h3>
            <p style="margin-bottom: var(--space-4);">Ambu provides manual breaths
                give temporary manual support.</p>

            <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Use Ambu with oxygen
                support when:</p>
            <ul style="font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.8;">
                <li>SpO2 dropping - immediate support</li>
                <li>Before/after suction - mobilizes secretions</li>
                <li>PALS feeling breathless - quick relief</li>
                <li>High pulse/BP from discomfort</li>
                <li>During neb if PALS struggling</li>
            </ul>

            <div class="tip-box">
                <p style="margin: 0;"><strong>Pro tip:</strong> When unsure what's wrong, give Ambu for 1 minute. It
                    provides quick relief and gives time to assess properly.</p>
            </div>
        </div>

        <!-- Critical Warnings -->
        <div class="warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Balloon/Cuff - Critical Safety</h3>

            <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">NEVER deflate balloon
                directly!</p>
            <p style="margin-bottom: var(--space-4);">Secretions collect above the cuff. Direct deflation drops them
                into lungs.</p>

            <div class="grid-2">
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Correct
                        Sequence:</p>
                    <ol style="font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>Subglottic suction FIRST</li>
                        <li>Deflate balloon slowly</li>
                        <li>Quick suction while deflated</li>
                        <li>Reinflate immediately</li>
                    </ol>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">If "balloon too
                        tight/loose":</p>
                    <ul style="font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>Check pressure </li>
                        <li>Should be 20-25 cmH2O</li>
                        <li>Adjust by small amounts only</li>
                    </ul>
                </div>
            </div>

            <p
                style="font-size: var(--font-size-sm); border-top: 1px solid var(--color-border); padding-top: var(--space-3); margin-top: var(--space-3);">
                <strong>If not confident:</strong> Only do subglottic suction. Call trained person for balloon work.
            </p>
        </div>

        <div class="warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Mucus Plug - Act Fast</h3>
            <p style="margin-bottom: var(--space-3);">Signs: Sudden SpO2 crash, catheter won't pass, PALS in distress
            </p>

            <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Action:</p>
            <ol style="font-size: var(--font-size-sm); line-height: 1.8; margin-bottom: var(--space-4);">
                <li>2ml NS into trach</li>
                <li>8-10 firm Ambu squeezes</li>
                <li>Try suction again</li>
                <li>If still blocked → Consider tube change</li>
            </ol>

            <p style="font-size: var(--font-size-sm);"><strong>Always keep:</strong> Backup tube at bedside (same size +
                one smaller), trained person's number ready.</p>
        </div>

        <!-- Equipment Check -->
        <div class="section-box">
            <h3>Quick Equipment Check</h3>
            <div class="grid-4">
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Ventilator</p>
                    <ul style="color: var(--color-text-tertiary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>☐ Running normally</li>
                        <li>☐ Settings unchanged</li>
                        <li>☐ No alarms</li>
                    </ul>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Circuit</p>
                    <ul style="color: var(--color-text-tertiary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>☐ All connections tight</li>
                        <li>☐ No kinks</li>
                        <li>☐ Valve present</li>
                    </ul>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Airway</p>
                    <ul style="color: var(--color-text-tertiary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>☐ Tube in position</li>
                        <li>☐ Cuff inflated</li>
                        <li>☐ Ties secure</li>
                    </ul>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">At Bedside</p>
                    <ul style="color: var(--color-text-tertiary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li>☐ Ambu bag</li>
                        <li>☐ Suction ready</li>
                        <li>☐ Backup tube</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Quick Reference -->
        <div class="section-box">
            <h3>Quick Reference Summary</h3>
            <div class="grid-2">
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">Always Remember:
                    </p>
                    <ul style="font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.8;">
                        <li>Ask PALS first - they know their body</li>
                        <li>Ambu provides quick relief and buys time</li>
                        <li>NS is optional - skip if uncomfortable</li>
                        <li>Subglottic suction BEFORE balloon work</li>
                        <li>High BP/pulse (non-BP patient) = discomfort</li>
                    </ul>
                </div>
                <div>
                    <p style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2);">PALS is Stable
                        When:</p>
                    <ul style="font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.8;">
                        <li>PALS says "I feel better now"</li>
                        <li>SpO2 > 94% and stable</li>
                        <li>Pulse settling to normal</li>
                        <li>Breathing looks comfortable</li>
                        <li>No ventilator alarms</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Emergency Contacts -->
        <div class="section-box">
            <h3>Emergency Contacts</h3>
            <div class="grid-4">
                <div>
                    <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Doctor</p>
                    <div class="contact-input"></div>
                </div>
                <div>
                    <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Hospital / Ambulance
                    </p>
                    <div class="contact-input"></div>
                </div>
                <div>
                    <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">TT Tube Change Person
                    </p>
                    <div class="contact-input"></div>
                </div>
                <div>
                    <p style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">Ventilator Technician
                    </p>
                    <div class="contact-input"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-note">
            <p>Keep this at bedside for quick reference</p>
            <p style="margin-top: var(--space-1);">This guide is based on practical home care experience. Always consult
                your medical team for specific advice.</p>
        </div>

    </div>
</div>

<script>
    mermaid.initialize({
        startOnLoad: true,
        theme: 'base',
        flowchart: {
            curve: 'basis',
            padding: 20,
            nodeSpacing: 35,
            rankSpacing: 45,
            htmlLabels: true
        },
        themeVariables: {
            primaryColor: '#e8e7f3',
            primaryTextColor: '#2d2d2d',
            primaryBorderColor: '#5b5a8f',
            lineColor: '#6b9a9f',
            secondaryColor: '#e3f1f2',
            tertiaryColor: '#ecf3ed',
            background: '#fafafa',
            mainBkg: '#f5f5f9',
            secondaryBkg: '#e8f5f6',
            tertiaryBkg: '#f0f5f1',
            nodeBorder: '#5b5a8f',
            clusterBkg: '#ffffff',
            clusterBorder: '#d0cfe6',
            fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif',
            fontSize: '14px'
        }
    });
</script>
{% endblock %}